import { COLORS_BY_OPERATOR, OPERATORS_BY_RETURNED_FN_BODY } from './meta';
let lastLogDebuggerId;
let lastLogOperatorExecCountMsg;
const PREFIX = '➰ ';
export class Logger {
    constructor(debuggerId, operators, hideOutputs, noStyling) {
        this.debuggerId = debuggerId;
        this.hideOutputs = hideOutputs;
        this.noStyling = noStyling;
        this.operatorsExecCountMap = {};
        this.longestOperatorExecCountMsgLen = 0;
        this.subCount = 0;
        this.startMsg = debuggerId + ' >> START';
        this.endMsg = debuggerId + ' >> END';
        this.subscriptionMsg = debuggerId + ' >> SUBSCRIBED';
        this.erroredMsg = debuggerId + ' >> ERRORED';
        this.completedMsg = debuggerId + ' >> COMPLETED';
        this.basePad = 7;
        this.pad =
            this.basePad +
                Math.max(this.startMsg.length, this.endMsg.length, this.subscriptionMsg.length, this.completedMsg.length);
        this.operatorNames = ['source'].concat(operators.map(op => OPERATORS_BY_RETURNED_FN_BODY[String(op)] || ''));
        this.longestNameLen = this.operatorNames.reduce((a, b) => (a.length > b.length ? a : b)).length;
    }
    logStart() {
        const msg = this.startMsg.padEnd(this.basePad + this.pad, '_');
        console.log(this.newLines(2) + PREFIX + msg + this.subCountMsg.padStart(4, '_') + '__▽');
    }
    logResume() {
        if ((lastLogDebuggerId && lastLogDebuggerId !== this.debuggerId) ||
            (lastLogOperatorExecCountMsg &&
                lastLogOperatorExecCountMsg !== this.currentOperatorExecCountMsg)) {
            const msg = this.debuggerId.padEnd(this.basePad + this.pad, '_');
            console.log(this.newLines(2) + PREFIX + msg + this.subCountMsg.padStart(4, '_') + '___');
        }
    }
    logEnd() {
        const msg = this.endMsg.padEnd(this.basePad + this.pad, '‾');
        console.log(PREFIX + msg + this.subCountMsg.padStart(4, '‾') + '‾‾△' + this.newLines(3));
    }
    logOperator(opIndex, value) {
        const opName = this.operatorNames[opIndex];
        const opIndexStr = String(opIndex).padStart(2, ' ');
        const paddedIndexAndName = (opIndexStr + ' ' + opName).padEnd(this.longestNameLen + 4, ' ');
        const paddedExecCountMsg = `${this.currentOperatorExecCountMsg}`
            .padStart(this.longestOperatorExecCountMsgLen, ' ')
            .padEnd(this.longestOperatorExecCountMsgLen + 1, ' ');
        console.log(PREFIX + (this.noStyling ? '' : '%c') + paddedIndexAndName + paddedExecCountMsg, this.noStyling
            ? ''
            : `color: ${COLORS_BY_OPERATOR[opName]}; background-color: #000; padding: 3px; border-radius: 6px;`, this.hideOutputs === true ? '' : value);
        lastLogDebuggerId = this.debuggerId;
        lastLogOperatorExecCountMsg = this.currentOperatorExecCountMsg;
    }
    prepare(opIndex) {
        var _a;
        const opName = this.operatorNames[opIndex];
        this.operatorsExecCountMap[opIndex + opName] =
            ((_a = this.operatorsExecCountMap[opIndex + opName]) !== null && _a !== void 0 ? _a : 0) + 1;
        this.currentOperatorExecCountMsg =
            this.operatorsExecCountMap[opIndex + opName] > 1
                ? ` (${this.operatorsExecCountMap[opIndex + opName]})`
                : '';
        this.longestOperatorExecCountMsgLen = Math.max(this.longestOperatorExecCountMsgLen, this.currentOperatorExecCountMsg.length);
    }
    addSubscription() {
        this.subCount++;
        this.subCountMsg = this.subCount > 1 ? `S:${this.subCount}` : '';
        const msg = this.subscriptionMsg.padEnd(this.basePad + this.pad, '-');
        console.log(this.newLines(1) + PREFIX + msg + this.subCountMsg.padStart(4, '-') + '--▼' + this.newLines(2));
    }
    logErrored() {
        const msg = this.erroredMsg.padEnd(this.basePad + this.pad, '-');
        console.log(this.newLines(1) + PREFIX + msg + this.subCountMsg.padStart(4, '-') + '--▲' + this.newLines(2));
    }
    logCompleted() {
        const msg = this.completedMsg.padEnd(this.basePad + this.pad, '-');
        console.log(this.newLines(1) + PREFIX + msg + this.subCountMsg.padStart(4, '-') + '--▲' + this.newLines(2));
    }
    newLines(n) {
        return this.noStyling ? '' : Array(n).fill('\n').join('');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3BhY2thZ2VzL3J4anMtZGVidWcvc3JjLyIsInNvdXJjZXMiOlsibGliL2xvZ2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsa0JBQWtCLEVBQUUsNkJBQTZCLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFFekUsSUFBSSxpQkFBeUIsQ0FBQztBQUM5QixJQUFJLDJCQUFtQyxDQUFDO0FBQ3hDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQztBQUVwQixNQUFNLE9BQU8sTUFBTTtJQW1CakIsWUFDVyxVQUFrQixFQUMzQixTQUFnQixFQUNSLFdBQW9CLEVBQ3BCLFNBQWtCO1FBSGpCLGVBQVUsR0FBVixVQUFVLENBQVE7UUFFbkIsZ0JBQVcsR0FBWCxXQUFXLENBQVM7UUFDcEIsY0FBUyxHQUFULFNBQVMsQ0FBUztRQVhYLDBCQUFxQixHQUFHLEVBQUUsQ0FBQztRQUNwQyxtQ0FBOEIsR0FBRyxDQUFDLENBQUM7UUFHbkMsYUFBUSxHQUFHLENBQUMsQ0FBQztRQVNuQixJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsR0FBRyxXQUFXLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsVUFBVSxHQUFHLGdCQUFnQixDQUFDO1FBQ3JELElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxHQUFHLGFBQWEsQ0FBQztRQUM3QyxJQUFJLENBQUMsWUFBWSxHQUFHLFVBQVUsR0FBRyxlQUFlLENBQUM7UUFDakQsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLEdBQUc7WUFDTixJQUFJLENBQUMsT0FBTztnQkFDWixJQUFJLENBQUMsR0FBRyxDQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFDbEIsSUFB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LENBQUMsQ0FBQztRQUNuRSxPQUFPLENBQUMsR0FBRyxDQUNULElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQy9GLENBQUM7SUFDSixDQUFDO0lBRU8sUUFBUSxDQUFDLENBQVM7UUFDeEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q09MT1JTX0JZX09QRVJBVE9SLCBPUEVSQVRPUlNfQllfUkVUVVJORURfRk5fQk9EWX0gZnJvbSAnLi9tZXRhJztcblxubGV0IGxhc3RMb2dEZWJ1Z2dlcklkOiBzdHJpbmc7XG5sZXQgbGFzdExvZ09wZXJhdG9yRXhlY0NvdW50TXNnOiBzdHJpbmc7XG5jb25zdCBQUkVGSVggPSAn4p6wICc7XG5cbmV4cG9ydCBjbGFzcyBMb2dnZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXJ0TXNnOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgZW5kTXNnOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3Vic2NyaXB0aW9uTXNnOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29tcGxldGVkTXNnOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXJyb3JlZE1zZzogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IGJhc2VQYWQ6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBwYWQ6IG51bWJlcjtcblxuICByZWFkb25seSBvcGVyYXRvck5hbWVzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBsb25nZXN0TmFtZUxlbjogbnVtYmVyO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgb3BlcmF0b3JzRXhlY0NvdW50TWFwID0ge307XG4gIHByaXZhdGUgbG9uZ2VzdE9wZXJhdG9yRXhlY0NvdW50TXNnTGVuID0gMDtcbiAgcHJpdmF0ZSBjdXJyZW50T3BlcmF0b3JFeGVjQ291bnRNc2c6IHN0cmluZztcblxuICBwcml2YXRlIHN1YkNvdW50ID0gMDtcbiAgcHJpdmF0ZSBzdWJDb3VudE1zZzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IGRlYnVnZ2VySWQ6IHN0cmluZyxcbiAgICBvcGVyYXRvcnM6IGFueVtdLFxuICAgIHByaXZhdGUgaGlkZU91dHB1dHM6IGJvb2xlYW4sXG4gICAgcHJpdmF0ZSBub1N0eWxpbmc6IGJvb2xlYW5cbiAgKSB7XG4gICAgdGhpcy5zdGFydE1zZyA9IGRlYnVnZ2VySWQgKyAnID4+IFNUQVJUJztcbiAgICB0aGlzLmVuZE1zZyA9IGRlYnVnZ2VySWQgKyAnID4+IEVORCc7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25Nc2cgPSBkZWJ1Z2dlcklkICsgJyA+PiBTVUJTQ1JJQkVEJztcbiAgICB0aGlzLmVycm9yZWRNc2cgPSBkZWJ1Z2dlcklkICsgJyA+PiBFUlJPUkVEJztcbiAgICB0aGlzLmNvbXBsZXRlZE1zZyA9IGRlYnVnZ2VySWQgKyAnID4+IENPTVBMRVRFRCc7XG4gICAgdGhpcy5iYXNlUGFkID0gNztcbiAgICB0aGlzLnBhZCA9XG4gICAgICB0aGlzLmJhc2VQYWQgK1xuICAgICAgTWF0aC5tYXgoXG4gICAgICAgIHRoaXMuc3RhcnRNc2cubGVuZ3RoLFxuICAgICAgICB0aGlzLmVuZE1zZy5sZW5ndGgsXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTXNnLmxlbmd0aCxcbiAgICAgICAgdGhpcy5jb21wbGV0ZWRNc2cubGVuZ3RoXG4gICAgICApO1xuXG4gICAgdGhpcy5vcGVyYXRvck5hbWVzID0gWydzb3VyY2UnXS5jb25jYXQoXG4gICAgICBvcGVyYXRvcnMubWFwKG9wID0+IE9QRVJBVE9SU19CWV9SRVRVUk5FRF9GTl9CT0RZW1N0cmluZyhvcCldIHx8ICcnKVxuICAgICk7XG4gICAgdGhpcy5sb25nZXN0TmFtZUxlbiA9IHRoaXMub3BlcmF0b3JOYW1lcy5yZWR1Y2UoKGEsIGIpID0+IChhLmxlbmd0aCA+IGIubGVuZ3RoID8gYSA6IGIpKS5sZW5ndGg7XG4gIH1cblxuICBsb2dTdGFydCgpOiB2b2lkIHtcbiAgICBjb25zdCBtc2cgPSB0aGlzLnN0YXJ0TXNnLnBhZEVuZCh0aGlzLmJhc2VQYWQgKyB0aGlzLnBhZCwgJ18nKTtcbiAgICBjb25zb2xlLmxvZyh0aGlzLm5ld0xpbmVzKDIpICsgUFJFRklYICsgbXNnICsgdGhpcy5zdWJDb3VudE1zZy5wYWRTdGFydCg0LCAnXycpICsgJ19f4pa9Jyk7XG4gIH1cblxuICBsb2dSZXN1bWUoKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgKGxhc3RMb2dEZWJ1Z2dlcklkICYmIGxhc3RMb2dEZWJ1Z2dlcklkICE9PSB0aGlzLmRlYnVnZ2VySWQpIHx8XG4gICAgICAobGFzdExvZ09wZXJhdG9yRXhlY0NvdW50TXNnICYmXG4gICAgICAgIGxhc3RMb2dPcGVyYXRvckV4ZWNDb3VudE1zZyAhPT0gdGhpcy5jdXJyZW50T3BlcmF0b3JFeGVjQ291bnRNc2cpXG4gICAgKSB7XG4gICAgICBjb25zdCBtc2cgPSB0aGlzLmRlYnVnZ2VySWQucGFkRW5kKHRoaXMuYmFzZVBhZCArIHRoaXMucGFkLCAnXycpO1xuICAgICAgY29uc29sZS5sb2codGhpcy5uZXdMaW5lcygyKSArIFBSRUZJWCArIG1zZyArIHRoaXMuc3ViQ291bnRNc2cucGFkU3RhcnQoNCwgJ18nKSArICdfX18nKTtcbiAgICB9XG4gIH1cblxuICBsb2dFbmQoKTogdm9pZCB7XG4gICAgY29uc3QgbXNnID0gdGhpcy5lbmRNc2cucGFkRW5kKHRoaXMuYmFzZVBhZCArIHRoaXMucGFkLCAn4oC+Jyk7XG4gICAgY29uc29sZS5sb2coUFJFRklYICsgbXNnICsgdGhpcy5zdWJDb3VudE1zZy5wYWRTdGFydCg0LCAn4oC+JykgKyAn4oC+4oC+4pazJyArIHRoaXMubmV3TGluZXMoMykpO1xuICB9XG5cbiAgbG9nT3BlcmF0b3Iob3BJbmRleDogbnVtYmVyLCB2YWx1ZSk6IHZvaWQge1xuICAgIGNvbnN0IG9wTmFtZTogc3RyaW5nID0gdGhpcy5vcGVyYXRvck5hbWVzW29wSW5kZXhdO1xuICAgIGNvbnN0IG9wSW5kZXhTdHIgPSBTdHJpbmcob3BJbmRleCkucGFkU3RhcnQoMiwgJyAnKTtcbiAgICBjb25zdCBwYWRkZWRJbmRleEFuZE5hbWUgPSAob3BJbmRleFN0ciArICcgJyArIG9wTmFtZSkucGFkRW5kKHRoaXMubG9uZ2VzdE5hbWVMZW4gKyA0LCAnICcpO1xuICAgIGNvbnN0IHBhZGRlZEV4ZWNDb3VudE1zZyA9IGAke3RoaXMuY3VycmVudE9wZXJhdG9yRXhlY0NvdW50TXNnfWBcbiAgICAgIC5wYWRTdGFydCh0aGlzLmxvbmdlc3RPcGVyYXRvckV4ZWNDb3VudE1zZ0xlbiwgJyAnKVxuICAgICAgLnBhZEVuZCh0aGlzLmxvbmdlc3RPcGVyYXRvckV4ZWNDb3VudE1zZ0xlbiArIDEsICcgJyk7XG5cbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIFBSRUZJWCArICh0aGlzLm5vU3R5bGluZyA/ICcnIDogJyVjJykgKyBwYWRkZWRJbmRleEFuZE5hbWUgKyBwYWRkZWRFeGVjQ291bnRNc2csXG4gICAgICB0aGlzLm5vU3R5bGluZ1xuICAgICAgICA/ICcnXG4gICAgICAgIDogYGNvbG9yOiAke0NPTE9SU19CWV9PUEVSQVRPUltvcE5hbWVdfTsgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsgcGFkZGluZzogM3B4OyBib3JkZXItcmFkaXVzOiA2cHg7YCxcbiAgICAgIHRoaXMuaGlkZU91dHB1dHMgPT09IHRydWUgPyAnJyA6IHZhbHVlXG4gICAgKTtcblxuICAgIGxhc3RMb2dEZWJ1Z2dlcklkID0gdGhpcy5kZWJ1Z2dlcklkO1xuICAgIGxhc3RMb2dPcGVyYXRvckV4ZWNDb3VudE1zZyA9IHRoaXMuY3VycmVudE9wZXJhdG9yRXhlY0NvdW50TXNnO1xuICB9XG5cbiAgcHJlcGFyZShvcEluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBvcE5hbWU6IHN0cmluZyA9IHRoaXMub3BlcmF0b3JOYW1lc1tvcEluZGV4XTtcblxuICAgIHRoaXMub3BlcmF0b3JzRXhlY0NvdW50TWFwW29wSW5kZXggKyBvcE5hbWVdID1cbiAgICAgICh0aGlzLm9wZXJhdG9yc0V4ZWNDb3VudE1hcFtvcEluZGV4ICsgb3BOYW1lXSA/PyAwKSArIDE7XG4gICAgdGhpcy5jdXJyZW50T3BlcmF0b3JFeGVjQ291bnRNc2cgPVxuICAgICAgdGhpcy5vcGVyYXRvcnNFeGVjQ291bnRNYXBbb3BJbmRleCArIG9wTmFtZV0gPiAxXG4gICAgICAgID8gYCAoJHt0aGlzLm9wZXJhdG9yc0V4ZWNDb3VudE1hcFtvcEluZGV4ICsgb3BOYW1lXX0pYFxuICAgICAgICA6ICcnO1xuXG4gICAgdGhpcy5sb25nZXN0T3BlcmF0b3JFeGVjQ291bnRNc2dMZW4gPSBNYXRoLm1heChcbiAgICAgIHRoaXMubG9uZ2VzdE9wZXJhdG9yRXhlY0NvdW50TXNnTGVuLFxuICAgICAgdGhpcy5jdXJyZW50T3BlcmF0b3JFeGVjQ291bnRNc2cubGVuZ3RoXG4gICAgKTtcbiAgfVxuXG4gIGFkZFN1YnNjcmlwdGlvbigpOiB2b2lkIHtcbiAgICB0aGlzLnN1YkNvdW50Kys7XG4gICAgdGhpcy5zdWJDb3VudE1zZyA9IHRoaXMuc3ViQ291bnQgPiAxID8gYFM6JHt0aGlzLnN1YkNvdW50fWAgOiAnJztcbiAgICBjb25zdCBtc2cgPSB0aGlzLnN1YnNjcmlwdGlvbk1zZy5wYWRFbmQodGhpcy5iYXNlUGFkICsgdGhpcy5wYWQsICctJyk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICB0aGlzLm5ld0xpbmVzKDEpICsgUFJFRklYICsgbXNnICsgdGhpcy5zdWJDb3VudE1zZy5wYWRTdGFydCg0LCAnLScpICsgJy0t4pa8JyArIHRoaXMubmV3TGluZXMoMilcbiAgICApO1xuICB9XG5cbiAgbG9nRXJyb3JlZCgpOiB2b2lkIHtcbiAgICBjb25zdCBtc2cgPSB0aGlzLmVycm9yZWRNc2cucGFkRW5kKHRoaXMuYmFzZVBhZCArIHRoaXMucGFkLCAnLScpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgdGhpcy5uZXdMaW5lcygxKSArIFBSRUZJWCArIG1zZyArIHRoaXMuc3ViQ291bnRNc2cucGFkU3RhcnQoNCwgJy0nKSArICctLeKWsicgKyB0aGlzLm5ld0xpbmVzKDIpXG4gICAgKTtcbiAgfVxuXG4gIGxvZ0NvbXBsZXRlZCgpOiB2b2lkIHtcbiAgICBjb25zdCBtc2cgPSB0aGlzLmNvbXBsZXRlZE1zZy5wYWRFbmQodGhpcy5iYXNlUGFkICsgdGhpcy5wYWQsICctJyk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICB0aGlzLm5ld0xpbmVzKDEpICsgUFJFRklYICsgbXNnICsgdGhpcy5zdWJDb3VudE1zZy5wYWRTdGFydCg0LCAnLScpICsgJy0t4payJyArIHRoaXMubmV3TGluZXMoMilcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXdMaW5lcyhuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm5vU3R5bGluZyA/ICcnIDogQXJyYXkobikuZmlsbCgnXFxuJykuam9pbignJyk7XG4gIH1cbn1cbiJdfQ==